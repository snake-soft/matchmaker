{% load join_by_attr signed dict_get attrib_get list_get%}

<script>
function loadDataTables(){
    var t = $('#teams-realtime').DataTable( {
    	"columnDefs": [ {
    		"searchable": false,
    		"targets": 0
    	} ],
    	"order": [[ 2, 'desc' ]]
    } );
    t.on( 'order.dt search.dt', function () {
    	t.column(0, {search:'applied', order:'applied'}).nodes().each( function (cell, i) {
    		cell.innerHTML = i+1;
    	} );
    } ).draw();
}
</script>
<div class="table-responsive">
<table id="teams-realtime" class="table table-striped table-bordered table-hover" >
	<thead>
		<tr>
			<th>#</th>
			<th>Team</th>
			<th>Score</th>
			<th>Win<wbr>:Draw<wbr>:Lose</th>
			<th>Close Win<wbr>:Lose</th>
			<th>Goals</th>
		</tr>
	</thead>
{% for team in object_list %}
	<tr>
		<th></th>
		<td data-order="{{ team.team_rating_as_int }}">
			<strong>
			{% if team.name %}
				<a href="{% url 'team-details' team.pk %}">
			{{ team.name }}
			{% else %}
				<a href="{% url 'team-new' %}?players={{constellation.team1.player_ids|join:','}}&next={{request.path}}" type="button" class="btn btn-warning">Create Team
			{% endif %}
			({{ team.team_rating_as_int }}{% if team.id in team_realtime.keys %}<i>{{ team_realtime|dict_get:team.id|attrib_get:'strength_diff'|signed}}={{ team_realtime|dict_get:team.id|attrib_get:'strength'}}</i>{% endif%})</a></strong>
		
			{% if not team.is_player_team or not team.name %}
			<ul>
			{% for player in team.players.all %}
				<li><a href="{% url 'player-details' player.pk %}">{{player.nick}} ({{player.rating_as_int}}{% if player.pk in player_realtime.keys %}<i>{{ player_realtime|dict_get:player.pk|attrib_get:'elo_diff'|signed}}={{ player_realtime|dict_get:player.pk|attrib_get:'elo_as_int'}}</i>{% endif%})</a></li>
			{% endfor %}
			</ul>
			{% endif %}
		</td>

		<!-- team_score -->
		{% if team.id in team_realtime.keys %}
			{% with rt_team=team_realtime|dict_get:team.id %}
				<td data-order="{{ team_realtime|dict_get:team.id|attrib_get:'team_score'}}">{{ team.team_score }}
					<br />{{ rt_team.team_score_diff|signed }}
					<br />={{ rt_team.team_score }}
				</td>
			{% endwith %}
		{% else %}
			<td data-order="{{ team.team_score }}">{{ team.team_score }}</td>
		{% endif%}

		<!-- Team Win Draw Lose -->
		{% if team.id in team_realtime.keys %}
			{% with rt_team=team_realtime|dict_get:team.id %}
				<td data-order="{{ team_realtime|dict_get:team.id|attrib_get:'team_wdl_factor'}}">{{ team.get_win_draw_lose.0 | length }}:{{ team.get_win_draw_lose.1 | length }}:{{ team.get_win_draw_lose.2 | length }}
					<br />{{ rt_team.team_wdl_diff.0 | signed }}:{{ rt_team.team_wdl_diff.1 | signed }}:{{ rt_team.team_wdl_diff.2 | signed }}
					<br />={{ rt_team.team_wdl.0 | length }}:{{ rt_team.team_wdl.1 | length }}:{{ rt_team.team_wdl.2 | length }}
				</td>
			{% endwith %}
		{% else %}
			<td>{{ team.get_win_draw_lose.0 | length }}:{{ team.get_win_draw_lose.1 | length }}:{{ team.get_win_draw_lose.2 | length }}</td>
		{% endif%}

		<!-- Team Close Win Lose -->
		{% if team.id in team_realtime.keys %}
			{% with rt_team=team_realtime|dict_get:team.id %}
				<td data-order="{{ team_realtime|dict_get:team.id|attrib_get:'close_wl_factor'}}">{{ team.close_win_lose.0 | length }}:{{ team.close_win_lose.1 | length }}
					<br />{{ rt_team.close_wl_diff.0 | signed }}:{{ rt_team.close_wl_diff.1 | signed}}
					<br />={{ rt_team.close_wl.0 | length }}:{{ rt_team.close_wl.1 | length }}
				</td>
			{% endwith %}
		{% else %}
			<td data-order="{{ team.close_wl_factor }}">{{ team.close_win_lose.0 | length }}:{{ team.close_win_lose.1 | length }}</td>
		{% endif%}

		<!-- Goals Own Foreign -->
		{% if team.id in team_realtime.keys %}
			{% with rt_team=team_realtime|dict_get:team.id %}
				<td data-order="{{ team_realtime|dict_get:team.id|attrib_get:'goal_factor'}}">{{ team.goal_own_foreign.0 }}:{{ team.goal_own_foreign.1 }}
					<br />={{ rt_team.realtime_goal_own_foreign.0 }}:{{ rt_team.realtime_goal_own_foreign.1 }} ({{ rt_team.goal_factor }})
				</td>
			{% endwith %}
		{% else %}
			<td data-order="{{team.goal_factor}}">{{ team.goal_own_foreign.0 }}:{{ team.goal_own_foreign.1 }}</td>
		{% endif%}
{% empty %}
<tr>
	<th></th>
	<td>
		<a href="{% url 'player-new' %}" class="btn btn-warning">Create players first</a>
	</td>
	<td></td>
	<td></td>
	<td></td>
	<td></td>
</tr>
{% endfor %}
</table>
<script>loadDataTables()</script>
</div>