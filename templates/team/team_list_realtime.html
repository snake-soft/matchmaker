{% load join_by_attr signed dict_get attrib_get list_get%}

{% if object_list %}
<script>
function loadDataTables(){
    var t = $('#teams-realtime').DataTable( {
    	"columnDefs": [ {
    		"searchable": false,
    		"targets": 0
    	} ],
    	"order": [[ 2, 'desc' ]]
    } );
    t.on( 'order.dt search.dt', function () {
    	t.column(0, {search:'applied', order:'applied'}).nodes().each( function (cell, i) {
    		cell.innerHTML = i+1;
    	} );
    } ).draw();
}
</script>
<div class="table-responsive">
<table id="teams-realtime" class="table table-striped table-bordered table-hover" >
	<thead>
		<tr>
			<th>#</th>
			<th>Team</th>
			<th>Score</th>
			<th>Win<wbr>:Draw<wbr>:Lose</th>
			<th>Close Win<wbr>:Lose</th>
			<th>Goals</th>
		</tr>
	</thead>
{% for team in object_list %}
	<tr>
		<th></th>
		<td data-order="{{ team.team_rating_as_int }}">
			<strong>
			{% if team.name %}
				<a href='/team/{{ team.id }}/'>
			{{ team.name }}
			{% else %}
				<a href='/new/team/?players={{constellation.team1.player_ids|join:","}}&next={{request.path}}' type="button" class="btn btn-warning">Create Team
			{% endif %}
			({{ team.team_rating_as_int }}{% if team.id in team_realtime.keys %}<i>{{ team_realtime|dict_get:team.id|attrib_get:'strength_diff'|signed}}={{ team_realtime|dict_get:team.id|attrib_get:'strength'}}</i>{% endif%})</a></strong>
		
			{% if not team.is_player_team or not team.name %}
			<ul>
			{% for player in team.players.all %}
				<li><a href="/player/{{player.pk}}/">{{player.nick}} ({{player.rating_as_int}}{% if player.pk in player_realtime.keys %}<i>{{ player_realtime|dict_get:player.pk|attrib_get:'elo_diff'|signed}}={{ player_realtime|dict_get:player.pk|attrib_get:'elo_as_int'}}</i>{% endif%})</a></li>
			{% endfor %}
			</ul>
			{% endif %}
		</td>

		<!-- team_score -->
		{% if team.id in team_realtime.keys %}
			<td data-order="{{ team_realtime|dict_get:team.id|attrib_get:'team_score'}}">{{ team.team_score }}
				<br />{{ team_realtime|dict_get:team.id|attrib_get:'team_score_diff'|signed}}
				<br />={{ team_realtime|dict_get:team.id|attrib_get:'team_score'}}
			</td>
		{% else %}
			<td data-order="{{ team.team_score }}">{{ team.team_score }}</td>
		{% endif%}

		<!-- Team Win Draw Lose -->
		{% if team.id in team_realtime.keys %}
			<td data-order="{{ team_realtime|dict_get:team.id|attrib_get:'team_wdl_factor'}}">{{ team.team_win | length }}:{{ team.team_draw | length }}:{{ team.team_lose | length }}
				<br />{{ team_realtime|dict_get:team.id|attrib_get:'team_win_diff' | signed }}:{{ team_realtime|dict_get:team.id|attrib_get:'team_draw_diff' | signed }}:{{ team_realtime|dict_get:team.id|attrib_get:'team_lose_diff' | signed }}
				<br />={{ team_realtime|dict_get:team.id|attrib_get:'team_win' | length }}:{{ team_realtime|dict_get:team.id|attrib_get:'team_draw' | length }}:{{ team_realtime|dict_get:team.id|attrib_get:'team_lose' | length }}
			</td>
		{% else %}
			<td>{{ team.team_win | length }}:{{ team.team_draw | length }}:{{ team.team_lose | length }}</td>
		{% endif%}

		<!-- Team Close Win Lose -->
		{% if team.id in team_realtime.keys %}
			<td data-order="{{ team_realtime|dict_get:team.id|attrib_get:'close_wl_factor'}}">{{ team.close_win | length }}:{{ team.close_lose | length }}
				<br />{{ team_realtime|dict_get:team.id|attrib_get:'close_win_diff' | signed }}:{{ team_realtime|dict_get:team.id|attrib_get:'close_lose_diff' | signed}}
				<br />={{ team_realtime|dict_get:team.id|attrib_get:'close_win' | length }}:{{ team_realtime|dict_get:team.id|attrib_get:'close_lose' | length }}
			</td>
		{% else %}
			<td data-order="{{ team.close_wl_factor }}">{{ team.close_win | length }}:{{ team.close_lose | length }}</td>
		{% endif%}
		
		<!-- Goals Own Foreign -->
		{% if team.id in team_realtime.keys %}
			<td data-order="{{ team_realtime|dict_get:team.id|attrib_get:'goal_factor'}}">{{ team.goal_own }}:{{ team.goal_foreign }}
				<br />={{ team_realtime|dict_get:team.id|attrib_get:'goal_own' }}:{{ team_realtime|dict_get:team.id|attrib_get:'goal_foreign' }} ({{ team_realtime|dict_get:team.id|attrib_get:'goal_factor'}})
			</td>
		{% else %}
		<td data-order="{{team.goal_factor}}">{{ team.goal_own }}:{{ team.goal_foreign }}</td>
		{% endif%}
		
{% endfor %}
</table>
</div>
<script>loadDataTables()</script>
{% endif %}